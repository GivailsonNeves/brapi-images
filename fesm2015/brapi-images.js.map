{"version":3,"file":"brapi-images.js.map","sources":["ng://brapi-images/src/app/brapi-images/models.ts","ng://brapi-images/src/app/brapi-images/product-image.pipe.ts","ng://brapi-images/src/app/brapi-images/brapi-images.module.ts"],"sourcesContent":["import { InjectionToken } from '@angular/core';\n\nexport interface _BrapiConfig {\n    pathApi: string;\n    userName: string;\n    password: string;\n    proposito: string;\n    defaultSize: number;\n}\n\nexport const BrapiConfig = new InjectionToken<_BrapiConfig>(\"BrapiConfig\");","import { Pipe, PipeTransform, Inject } from '@angular/core';\nimport { BrapiConfig, _BrapiConfig } from './models';\nimport { HttpClient } from '@angular/common/http';\nimport { Observable } from 'rxjs';\n\n@Pipe({\n  name: 'productImage'\n})\nexport class ProductImagePipe implements PipeTransform {\n\n  private static auth: BrapiAuth = null;\n\n  constructor(\n    @Inject(BrapiConfig) private config: _BrapiConfig,\n    private _http: HttpClient\n  ){}\n  transform(value: any, args?: any): Promise<string> {\n    console.log(value, args)\n    return new Promise((resolve, reject) => {\n      let storagePath: string = window.localStorage.getItem(args+value);\n      if (storagePath) {\n        resolve(storagePath);\n      } else {\n        let _requestToken: Observable<void> = null;\n        if (!ProductImagePipe.auth)\n          _requestToken = this._logInApi();\n        else if (ProductImagePipe.auth.isExpired())\n          _requestToken = this._loginRefresh();\n\n        if (_requestToken) {\n          _requestToken.subscribe(\n            data => {\n              this._requestImage(value, args)\n                .subscribe(\n                  res => resolve(res),\n                  error => resolve('')\n                )\n            }, error => {\n              resolve('');\n            }\n          )\n        } else {\n          this._requestImage(value, args)\n          .subscribe(\n            data => resolve(data),\n            error => resolve('')\n          )\n        }\n      }\n\n    });\n  }\n\n  private _requestImage(paramn: string, type: string):Observable<string> {\n    return Observable.create(\n      observer => {\n        let type = 'pesquisarPorSku';\n        let _data : any = {\n          medida : this.config.defaultSize, \n          proposito : this.config.proposito\n        }\n        if(type == 'ean') { \n          type = 'pesquisarPorEan'; \n          _data.eans = [paramn];\n        } else {\n          _data.skus = [paramn];\n        }\n\n        this._http.post(`${this.config.pathApi}api/${type}`, _data,{ headers : {\n          \"Authorization\": `${ProductImagePipe.auth.token_type} ${ProductImagePipe.auth.access_token}`\n        }}).subscribe(\n          (data: any) => { if(data && data.length){ \n            window.localStorage.setItem(type+paramn, data[0].url);\n            observer.next(data[0].url); \n          } else observer.next(''); },\n          error => observer.next('')\n        )\n      }\n    );\n  }\n\n  private _logInApi():Observable<void> {\n    return Observable.create(\n      observer => {\n        this._http.post(`${this.config.pathApi}api/login`, \n          {\n            username: this.config.userName, \n            password: this.config.password\n          }\n        ).subscribe(\n          data => { ProductImagePipe.auth = BrapiAuth.fromData(data); observer.next() },\n          error => {console.error(error); observer.error(error)}\n        );\n      }\n    );\n  }\n\n  private _loginRefresh():Observable<void> {\n    return Observable.create(\n      observer => {\n        this._http.post(`${this.config.pathApi}/oauth/refresh_token`, \n          {\n            grant_type: \"refresh_token\",\n            refresh_token: ProductImagePipe.auth.refresh_token\n          }\n        ).subscribe(\n          data => { ProductImagePipe.auth = BrapiAuth.fromData(data); observer.next() },\n          error => {console.error(error); observer.error(error)}\n        );\n      }\n    );\n  }\n\n}\n\nclass BrapiAuth {\n\n  public username: string; \n  public roles: string[]; \n  public token_type: string;\n  public access_token: string;\n  public expires_in: number;\n  public refresh_token: string;\n  public expireIn: number;\n\n  public static fromData(data: any): BrapiAuth {\n    let object =  data as BrapiAuth;\n    object.expireIn = object.expireIn * 1000 + new Date().getTime();\n    return object;\n  }\n\n  public isExpired(): boolean{\n    return new Date().getTime() >= (this.expireIn - 30000);\n  }\n\n}","import { NgModule, ModuleWithProviders } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { ProductImagePipe } from './product-image.pipe';\nimport { _BrapiConfig, BrapiConfig } from './models';\nimport { HttpClientModule } from '@angular/common/http';\n\n@NgModule({\n  declarations: [ProductImagePipe],\n  exports: [ProductImagePipe],\n  imports: [\n    CommonModule,\n    HttpClientModule\n  ]\n})\nexport class BrapiImagesModule { \n  static forRoot(config: _BrapiConfig): ModuleWithProviders{\n    return {\n      ngModule: BrapiImagesModule,\n      providers: [\n        ProductImagePipe,\n        {\n          provide: BrapiConfig,\n          useValue: config\n        }\n      ]\n    }\n  }\n}\n"],"names":[],"mappings":"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"}
